# P2L Backend Dockerfile - ç”Ÿäº§ä¼˜åŒ–ç‰ˆ
FROM python:3.10-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# ä½¿ç”¨Pythonå†…ç½®æ¨¡å—æ›¿ä»£ç³»ç»Ÿå·¥å…·ï¼Œé¿å…apt-get update
# wget/curlåŠŸèƒ½ç”±Pythonçš„urllibå®ç°

# å¤åˆ¶ä¾èµ–æ–‡ä»¶å¹¶å®‰è£…
COPY backend/requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt

# å¤åˆ¶æ•´ä¸ªé¡¹ç›®ç»“æ„
COPY . .

# åˆ›å»ºå¿…è¦ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /app/models /app/logs /app/backend/model_p2l/models && \
    chmod -R 755 /app && \
    chmod +x /app/p2l_tools.py

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app:/app/backend:/app/backend/model_p2l
ENV P2L_ENV=production
ENV P2L_HOST=0.0.0.0
ENV P2L_PORT=8080
ENV TOKENIZERS_PARALLELISM=false
ENV OMP_NUM_THREADS=4

# æš´éœ²ç«¯å£
EXPOSE 8080

# ä½¿ç”¨Pythonè¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œæ— éœ€ç³»ç»Ÿå·¥å…·
HEALTHCHECK --interval=30s --timeout=30s --start-period=600s --retries=10 \
    CMD python3 -c "import urllib.request; urllib.request.urlopen('http://localhost:8080/health', timeout=30)" || exit 1

# å¯åŠ¨å‘½ä»¤ - å…ˆæ£€æŸ¥æ¨¡å‹å†å¯åŠ¨æœåŠ¡
CMD ["/bin/bash", "-c", "echo 'ğŸ³ P2L Backendå®¹å™¨å¯åŠ¨' && echo 'ğŸ” æ£€æŸ¥P2Læ¨¡å‹...' && python3 p2l_tools.py ensure && echo 'ğŸš€ å¯åŠ¨backendæœåŠ¡...' && python -m backend.main"]
