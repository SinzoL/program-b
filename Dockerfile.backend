# P2L Backend Dockerfile - è½»é‡ä¼˜åŒ–ç‰ˆ
FROM python:3.10-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# è·³è¿‡ç³»ç»ŸåŒ…å®‰è£…ï¼Œä½¿ç”¨ Python å†…ç½®çš„ urllib è¿›è¡Œå¥åº·æ£€æŸ¥
# è¿™æ ·å¯ä»¥é¿å…ç½‘ç»œè¿æ¥é—®é¢˜å¯¼è‡´çš„æ„å»ºå¤±è´¥

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY backend/requirements.txt .
RUN pip install --no-cache-dir -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt

# å¤åˆ¶æ•´ä¸ªé¡¹ç›®ç»“æ„ä»¥æ”¯æŒç›¸å¯¹å¯¼å…¥
COPY . .

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p /app/models /app/logs

# ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
RUN chmod +x /app/ensure_model.py /app/model_utils.py

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONPATH=/app
ENV P2L_ENV=production
ENV P2L_HOST=0.0.0.0
ENV P2L_PORT=8080

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥ï¼ˆä½¿ç”¨ Python è€Œä¸æ˜¯ curlï¼‰
HEALTHCHECK --interval=60s --timeout=15s --start-period=300s --retries=5 \
    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8080/health')" || exit 1

# å¯åŠ¨å‘½ä»¤ - å…ˆæ£€æŸ¥æ¨¡å‹å†å¯åŠ¨æœåŠ¡
CMD ["/bin/bash", "-c", "echo 'ğŸ³ P2L Backendå®¹å™¨å¯åŠ¨' && echo 'ğŸ” æ£€æŸ¥P2Læ¨¡å‹...' && python3 ensure_model.py && echo 'ğŸš€ å¯åŠ¨backendæœåŠ¡...' && python -m backend.main"]